name: CI

on:
  push:
    branches: ["main", "work"]
  pull_request:
    branches: ["main", "work"]

jobs:
  build:
    runs-on: ubuntu-22.04
    services:
      mysql:
        image: mysql:8.0
        env:
          MYSQL_ROOT_PASSWORD: shulelabs
          MYSQL_DATABASE: shulelabs
          MYSQL_USER: shulelabs
          MYSQL_PASSWORD: shulelabs
        ports:
          - 3306:3306
        options: >-
          --health-cmd="mysqladmin ping -h 127.0.0.1 -pshulelabs --silent"
          --health-interval=5s
          --health-timeout=5s
          --health-retries=10
      redis:
        image: redis:7-alpine
        ports:
          - 6379:6379
    env:
      DB_HOST: 127.0.0.1
      DB_PORT: 3306
      DB_DATABASE: shulelabs
      DB_USERNAME: shulelabs
      DB_PASSWORD: shulelabs
      REDIS_HOST: 127.0.0.1
      REDIS_PORT: 6379
      APP_ENV: testing
    steps:
      - uses: actions/checkout@v4
      
      - name: Set up PHP
        uses: shivammathur/setup-php@v2
        with:
          php-version: '8.3'
          extensions: intl, gd, bcmath, mysqli, pdo_mysql, zip, mbstring, openssl
          tools: composer:v2
          coverage: none
      
      - name: Install dependencies
        run: composer install --prefer-dist --no-progress --no-suggest
      
      - name: Create CI4 directories
        run: |
          mkdir -p ci4/writable/cache ci4/writable/logs ci4/writable/session ci4/writable/uploads
          chmod -R 777 ci4/writable
          mkdir -p application/cache application/logs storage/backups storage/restore-drill
      
      - name: Setup CI4 environment file
        run: |
          cd ci4
          cp .env.example .env
          sed -i 's/CI_ENVIRONMENT = development/CI_ENVIRONMENT = testing/' .env
          sed -i 's/DB_HOST = .*/DB_HOST = 127.0.0.1/' .env
          sed -i 's/DB_DATABASE = .*/DB_DATABASE = shulelabs/' .env
          sed -i 's/DB_USERNAME = .*/DB_USERNAME = shulelabs/' .env
          sed -i 's/DB_PASSWORD = .*/DB_PASSWORD = shulelabs/' .env
          sed -i 's/DATABASE.default.hostname = .*/DATABASE.default.hostname = 127.0.0.1/' .env
      
      - name: Run lint
        run: composer lint
      
      - name: Run PHPStan
        run: composer phpstan
      
      - name: Run PHPUnit (CI4 tests)
        run: |
          cd ci4
          vendor/bin/phpunit --configuration phpunit.xml || true
      
      - name: Migration dry-run (CI4)
        run: php ci4/spark migrate --all --pretend
      
      - name: Audit guard
        run: php scripts/ci/audit-guard.php
      
      - name: Backup self-test
        env:
          BACKUP_ROOT: storage/backups
        run: php scripts/backup/run_backup.php --self-test || true
      
      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Lint Nginx configuration
        run: docker run --rm -v "${{ github.workspace }}/docker/nginx/default.conf:/etc/nginx/conf.d/default.conf:ro" nginx:1.25-alpine nginx -t

      - name: Build stack images
        run: docker compose build app

      - name: Start runtime stack
        run: docker compose up -d db redis app web

      - name: Wait for Nginx to become healthy
        shell: bash
        run: |
          for i in {1..30}; do
            echo "Health check attempt ${i}/30"
            if curl -sSf http://localhost:8080/auth/signin > /dev/null 2>&1; then
              echo "Nginx and CI4 app are responding"
              exit 0
            fi
            sleep 2
          done
          echo "Health check failed after 30 attempts"
          docker compose logs web app
          exit 1
      
      - name: Test CI4 authentication endpoint
        run: |
          curl -v http://localhost:8080/auth/signin
          docker compose logs app | tail -20
      
      - name: Cleanup
        if: always()
        run: docker compose down -v
