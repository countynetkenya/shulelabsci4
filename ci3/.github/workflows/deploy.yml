name: Deploy

on:
  push:
    tags:
      - 'v*'

jobs:
  deploy:
    runs-on: ubuntu-latest
    permissions:
      contents: read
      packages: write
    env:
      REGISTRY: ghcr.io
      IMAGE_NAME: ${{ github.repository }}
      CI_DB_HOST_OVERRIDE: 127.0.0.1
      CI_DB_PORT_OVERRIDE: 3306
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Materialise production environment file
        env:
          ENV_CONTENT: ${{ secrets.PRODUCTION_ENV_FILE }}
        run: |
          if [ -z "$ENV_CONTENT" ]; then
            echo "PRODUCTION_ENV_FILE secret is required for deployments" >&2
            exit 1
          fi
          printf '%s' "$ENV_CONTENT" > .env.production

      - name: Export production secrets
        id: export-secrets
        run: |
          python <<'PY'
import os
import sys
from pathlib import Path

env_path = Path('.env.production')
if not env_path.exists():
    print('Missing .env.production file', file=sys.stderr)
    sys.exit(1)

required_keys = ['DB_HOSTNAME', 'DB_DATABASE', 'DB_USERNAME', 'DB_PASSWORD']
optional_keys = ['DB_PORT', 'DB_ROOT_PASSWORD', 'OPERATIONS_ALERT_WEBHOOK', 'SCHEDULER_ALERT_THRESHOLD_SECONDS']

values = {}
for raw_line in env_path.read_text().splitlines():
    line = raw_line.strip()
    if not line or line.startswith('#'):
        continue
    if '=' not in line:
        continue
    key, value = line.split('=', 1)
    if value.startswith('"') and value.endswith('"'):
        value = value[1:-1]
    values[key] = value

missing = [key for key in required_keys if not values.get(key)]
if missing:
    print(f"Missing required environment keys: {', '.join(missing)}", file=sys.stderr)
    sys.exit(1)

github_env = Path(os.environ['GITHUB_ENV'])
with github_env.open('a', encoding='utf-8') as handle:
    for key in required_keys + optional_keys:
        if key in values and values[key]:
            handle.write(f"DEPLOY_{key}={values[key]}\n")

    handle.write(f"DB_HOSTNAME={values['DB_HOSTNAME']}\n")
    handle.write(f"DB_DATABASE={values['DB_DATABASE']}\n")
    handle.write(f"DB_USERNAME={values['DB_USERNAME']}\n")
    handle.write(f"DB_PASSWORD={values['DB_PASSWORD']}\n")
    handle.write(f"DB_PORT={values.get('DB_PORT', '3306')}\n")

github_output = Path(os.environ['GITHUB_OUTPUT'])
with github_output.open('a', encoding='utf-8') as handle:
    for key in required_keys:
        handle.write(f"{key.lower()}={values[key]}\n")
    if 'DB_ROOT_PASSWORD' in values and values['DB_ROOT_PASSWORD']:
        handle.write(f"db_root_password={values['DB_ROOT_PASSWORD']}\n")
PY

      - name: Activate production environment
        run: cp .env.production .env

      - name: Setup PHP
        uses: shivammathur/setup-php@v2
        with:
          php-version: '8.2'
          extensions: mbstring, intl, pdo_mysql, mysqli, openssl
          coverage: none

      - name: Install dependencies
        run: composer install --prefer-dist --no-progress --no-interaction

      - name: Launch ephemeral database for validation
        if: env.CI_DB_HOST_OVERRIDE != ''
        env:
          MYSQL_DATABASE: ${{ steps.export-secrets.outputs.db_database }}
          MYSQL_USER: ${{ steps.export-secrets.outputs.db_username }}
          MYSQL_PASSWORD: ${{ steps.export-secrets.outputs.db_password }}
          MYSQL_ROOT_PASSWORD: ${{ steps.export-secrets.outputs.db_root_password || steps.export-secrets.outputs.db_password }}
        run: |
          docker rm -f ci-db >/dev/null 2>&1 || true
          docker run -d --name ci-db \
            -e MYSQL_ROOT_PASSWORD="$MYSQL_ROOT_PASSWORD" \
            -e MYSQL_DATABASE="$MYSQL_DATABASE" \
            -e MYSQL_USER="$MYSQL_USER" \
            -e MYSQL_PASSWORD="$MYSQL_PASSWORD" \
            -p ${CI_DB_PORT_OVERRIDE:-3306}:3306 \
            mysql:8.0 \
            --default-authentication-plugin=mysql_native_password --character-set-server=utf8mb4 --collation-server=utf8mb4_unicode_ci

          for attempt in {1..30}; do
            if docker exec ci-db mysqladmin ping -h 127.0.0.1 -p"$MYSQL_ROOT_PASSWORD" --silent; then
              exit 0
            fi
            sleep 2
          done

          docker logs ci-db
          echo "Database failed to become ready" >&2
          exit 1

      - name: Run migrations
        env:
          CI_ENVIRONMENT: production
          DB_HOSTNAME: ${{ env.CI_DB_HOST_OVERRIDE != '' && env.CI_DB_HOST_OVERRIDE || env.DB_HOSTNAME }}
          DB_PORT: ${{ env.CI_DB_HOST_OVERRIDE != '' && env.CI_DB_PORT_OVERRIDE || env.DB_PORT }}
          DB_USERNAME: ${{ env.DB_USERNAME }}
          DB_PASSWORD: ${{ env.DB_PASSWORD }}
          DB_DATABASE: ${{ env.DB_DATABASE }}
        run: php index.php migrate latest

      - name: Tear down ephemeral database
        if: always() && env.CI_DB_HOST_OVERRIDE != ''
        run: docker rm -f ci-db || true

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Extract Docker metadata
        id: meta
        uses: docker/metadata-action@v5
        with:
          images: ${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}

      - name: Log in to container registry
        uses: docker/login-action@v3
        with:
          registry: ${{ env.REGISTRY }}
          username: ${{ secrets.REGISTRY_USERNAME }}
          password: ${{ secrets.REGISTRY_TOKEN }}

      - name: Build release image
        uses: docker/build-push-action@v5
        with:
          context: .
          file: docker/php-fpm/Dockerfile
          push: false
          load: true
          tags: ${{ steps.meta.outputs.tags }}
          labels: ${{ steps.meta.outputs.labels }}

      - name: Scan image for vulnerabilities
        uses: aquasecurity/trivy-action@0.20.0
        with:
          image-ref: ${{ steps.meta.outputs.tags }}
          vuln-type: 'os,library'
          severity: 'CRITICAL,HIGH'
          ignore-unfixed: true

      - name: Push image tags
        run: |
          while IFS= read -r tag; do
            if [ -n "$tag" ]; then
              docker image push "$tag"
            fi
          done <<< "${{ steps.meta.outputs.tags }}"

      - name: Deploy artifact
        run: |
          echo "Deployment pipeline triggered for $GITHUB_REF"
          # Insert deployment automation here (rsync, helm, etc.)
