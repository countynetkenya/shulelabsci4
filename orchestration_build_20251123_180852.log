[0;34m[2025-11-23 18:08:52][0m 
[0;34m[2025-11-23 18:08:52][0m â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
[0;34m[2025-11-23 18:08:52][0m   ShuleLabs AI Orchestration Engine v2.0
[0;34m[2025-11-23 18:08:52][0m   Complete Autonomous Build - 6 Phases
[0;34m[2025-11-23 18:08:52][0m â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
[0;34m[2025-11-23 18:08:52][0m 
[0;34m[2025-11-23 18:08:52][0m â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—
[0;34m[2025-11-23 18:08:52][0m â•‘ PHASE 0: PRE-FLIGHT VALIDATION                                 â•‘
[0;34m[2025-11-23 18:08:52][0m â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
[0;36mâ„¹ï¸  [2025-11-23 18:08:52][0m Checking PHP version...
[0;32mâœ… [2025-11-23 18:08:52][0m PHP 8.3 detected
[0;36mâ„¹ï¸  [2025-11-23 18:08:52][0m Checking PHP extensions...
[0;32mâœ… [2025-11-23 18:08:52][0m Extension intl: installed
[0;32mâœ… [2025-11-23 18:08:52][0m Extension mbstring: installed
[0;32mâœ… [2025-11-23 18:08:52][0m Extension json: installed
[0;32mâœ… [2025-11-23 18:08:53][0m Extension xml: installed
[0;32mâœ… [2025-11-23 18:08:53][0m Extension curl: installed
[1;33mâš ï¸  [2025-11-23 18:08:53][0m Extension zip: MISSING
[1;33mâš ï¸  [2025-11-23 18:08:53][0m Extension gd: MISSING
[1;33mâš ï¸  [2025-11-23 18:08:53][0m Missing extensions: zip gd
[0;36mâ„¹ï¸  [2025-11-23 18:08:53][0m Auto-installing missing extensions...
Reading package lists...
Building dependency tree...
Reading state information...
php8.3-zip is already the newest version (8.3.6-0ubuntu0.24.04.5).
0 upgraded, 0 newly installed, 0 to remove and 12 not upgraded.
Reading package lists...
Building dependency tree...
Reading state information...
php8.3-gd is already the newest version (8.3.6-0ubuntu0.24.04.5).
0 upgraded, 0 newly installed, 0 to remove and 12 not upgraded.
[0;36mâ„¹ï¸  [2025-11-23 18:08:55][0m Testing database connection...
[0;36mâ„¹ï¸  [2025-11-23 18:08:55][0m Checking disk space...
[0;32mâœ… [2025-11-23 18:08:55][0m Disk space: 19GB available
[0;36mâ„¹ï¸  [2025-11-23 18:08:55][0m Checking Git repository...
[0;32mâœ… [2025-11-23 18:08:55][0m Git repository detected
[1;33mâš ï¸  [2025-11-23 18:08:55][0m Uncommitted changes detected
[0;36mâ„¹ï¸  [2025-11-23 18:08:55][0m Scanning for PHP reserved keywords in planned classes...
[0;32mâœ… [2025-11-23 18:08:55][0m No reserved keywords detected in class names
[0;36mâ„¹ï¸  [2025-11-23 18:08:55][0m Checking file permissions...
[0;32mâœ… [2025-11-23 18:08:55][0m writable/ directory is writable
[0;36mâ„¹ï¸  [2025-11-23 18:08:55][0m Checking Composer...
[0;32mâœ… [2025-11-23 18:08:55][0m Composer installed
./composer.json is valid
[0;32mâœ… [2025-11-23 18:08:55][0m composer.json is valid
[0;32mâœ… [2025-11-23 18:08:55][0m Phase 0 complete in 3 seconds
[0;34m[2025-11-23 18:08:55][0m â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—
[0;34m[2025-11-23 18:08:55][0m â•‘ PHASE 1: DATABASE-FIRST FOUNDATION                             â•‘
[0;34m[2025-11-23 18:08:55][0m â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
[0;36mâ„¹ï¸  [2025-11-23 18:08:55][0m Running database migrations...
Xdebug: [Step Debug] Could not connect to debugging client. Tried: localhost:9003 (through xdebug.client_host/xdebug.client_port).

CodeIgniter v4.6.3 Command Line Tool - Server Time: 2025-11-23 18:08:55 UTC+00:00

Running all new migrations...
Migrations complete.
[0;32mâœ… [2025-11-23 18:08:55][0m Migrations executed successfully
[0;36mâ„¹ï¸  [2025-11-23 18:08:55][0m Verifying database schema...
[0;32mâœ… [2025-11-23 18:08:55][0m Database has 31 tables
[0;32mâœ… [2025-11-23 18:08:55][0m Phase 1 complete in 0 seconds
[0;34m[2025-11-23 18:08:55][0m â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—
[0;34m[2025-11-23 18:08:55][0m â•‘ PHASE 2: TEST-DRIVEN DEVELOPMENT                               â•‘
[0;34m[2025-11-23 18:08:55][0m â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
[0;36mâ„¹ï¸  [2025-11-23 18:08:55][0m Running test suite...
Xdebug: [Step Debug] Could not connect to debugging client. Tried: localhost:9003 (through xdebug.client_host/xdebug.client_port).
PHPUnit 10.5.58 by Sebastian Bergmann and contributors.

Runtime:       PHP 8.3.14
Configuration: /workspaces/shulelabsci4/phpunit.xml

.........Starting CI4 users backfill from CI3 tables...
Table systemadmin does not exist, skipping.
Migrated 0 users from systemadmin
Table user does not exist, skipping.
Migrated 0 users from user
Table teacher does not exist, skipping.
Migrated 0 users from teacher
Table student does not exist, skipping.
Migrated 0 users from student
Table parents does not exist, skipping.
Migrated 0 users from parents
Total users migrated: 0
...................................................F..  63 / 206 ( 30%)
...........E..F.FFRF.FR.FFF.F........FF..................EF.FFF 126 / 206 ( 61%)
FFFFF....FEFEFFFFFF........EF.FFEEFFFF......................... 189 / 206 ( 91%)
.....EF.FFFFEFF.F                                               206 / 206 (100%)

Time: 00:03.948, Memory: 26.00 MB

Audit Service (Tests\Ci4\Foundation\AuditService)
 âœ” Record event persists hash chain
 âœ” Verify integrity detects tampering
 âœ” Seal day persists seal record

Database Compatibility Service (Tests\Ci4\Compat\DatabaseCompatibilityService)
 âœ” Audit detects missing tables
 âœ” Audit detects missing columns
 âœ” Audit passes when schema is complete
 âœ” Generate sql patches for missing columns
 âœ” Add experimental tables adds okr tables
 âœ” Generate migration content

Database Config (Tests\Ci4\Config\DatabaseConfig)
 âœ” Database config reads from env
 âœ” Default database config has correct structure
 âœ” Tests config uses in memory s q lite

Document Catalog (Tests\Ci4\Library\DocumentCatalog)
 âœ” Register document uploads to drive issues qr and audits

Enrollment Service (Tests\Foundation\EnrollmentService)
 âœ” Enroll student
 âœ” Enroll student with parent
 âœ” Enroll student in non existent class
 âœ” Cannot enroll duplicate student
 âœ” Transfer class
 âœ” Transfer to non existent class
 âœ” Get class enrollments
 âœ” Withdraw student
 âœ” Withdraw non existent enrollment
 âœ” Get class enrollments excludes withdrawn

Event Bus (Tests\Ci4\Threads\EventBus)
 âœ” Dispatch invokes all subscribers and captures failures

Finance Service (Tests\Finance\FinanceService)
 âœ” Get school invoices
 âœ” Create invoice
 âœ” Record payment
 âœ” Record full payment
 âœ” Get invoice details
 âœ” Get payment stats
 âœ” Get outstanding invoices
 âœ” Get fee structure
 âœ” Set fee structure
 âœ” Update fee structure

Gamification Service (Tests\Ci4\Gamification\GamificationService)
 âœ” Handle recognition awarded increments points and awards badges

Hr Service (Tests\Hr\HrService)
 âœ” Get school staff
 âœ” Get school staff with role filter
 âœ” Assign teacher
 âœ” Cannot assign teacher twice
 âœ” Remove teacher
 âœ˜ Get teacher classes
   â”‚
   â”‚ Failed asserting that 0 is greater than 0.
   â”‚
   â”‚ /workspaces/shulelabsci4/tests/Hr/HrServiceTest.php:179
   â”‚
 âœ˜ Assign teacher to class
   â”‚
   â”‚ Failed asserting that false is true.
   â”‚
   â”‚ /workspaces/shulelabsci4/tests/Hr/HrServiceTest.php:187
   â”‚
 âœ” Cannot assign teacher to class in different school
 âœ” Get staff stats
 âœ” Staff stats excludes students and parents

Install Service (Tests\Ci4\Foundation\InstallService)
 âœ” Is installed returns false when no tenants
 âœ” Is installed returns true when tenants exist
 âœ” Check database connection returns true
 âœ” Check migrations returns success
 âœ” Create tenants succeeds
 âœ” Create tenants generates ids when not provided
 âœ” Create admin user succeeds
 âœ” Create admin user throws when username exists
 âœ” Create admin user throws when email exists

Integration Registry (Tests\Ci4\Foundation\IntegrationRegistry)
 âœ” Register dispatch persists and enforces idempotency
 âœ” Mark completed updates status and audit
 âœ” Mark failed updates status and audit
 âœ” Mark completed throws when dispatch missing
 âœ” Claim pending dispatches returns processing rows

Integration Service (Tests\Ci4\Integrations\IntegrationService)
 âœ” Can register adapter
 âœ” Can get registered adapter
 âœ” Get registered adapters returns array
 âœ” Check health returns status
 âœ” Throws exception for unknown adapter

Inventory Service (Tests\Inventory\InventoryService)
 âœ˜ Add asset
   â”‚
   â”‚ ErrorException: Trying to access array offset on null
   â”‚
   â”‚ /workspaces/shulelabsci4/tests/Inventory/InventoryServiceTest.php:35
   â”‚
 âœ˜ Get school assets
   â”‚
   â”‚ Failed asserting that 0 is greater than 0.
   â”‚
   â”‚ /workspaces/shulelabsci4/tests/Inventory/InventoryServiceTest.php:48
   â”‚
 âœ” Get school assets by category
 âœ˜ Update quantity in
   â”‚
   â”‚ Failed asserting that false is true.
   â”‚
   â”‚ /workspaces/shulelabsci4/tests/Inventory/InventoryServiceTest.php:71
   â”‚
 âœ˜ Update quantity out
   â”‚
   â”‚ Failed asserting that false is true.
   â”‚
   â”‚ /workspaces/shulelabsci4/tests/Inventory/InventoryServiceTest.php:86
   â”‚
 âœ˜ Cannot reduce below zero
   â”‚
   â”‚ Failed asserting that 'Asset not found' [ASCII](length: 15) contains "Insufficient quantity" [ASCII](length: 21).
   â”‚
   â”‚ /workspaces/shulelabsci4/tests/Inventory/InventoryServiceTest.php:98
   â”‚
 âœ˜ Get asset transactions
   â”‚
   â”‚ Failed asserting that 0 is equal to 3 or is greater than 3.
   â”‚
   â”‚ /workspaces/shulelabsci4/tests/Inventory/InventoryServiceTest.php:113
   â”‚
 âœ˜ Get low stock items
   â”‚
   â”‚ Failed asserting that 0 is greater than 0.
   â”‚
   â”‚ /workspaces/shulelabsci4/tests/Inventory/InventoryServiceTest.php:124
   â”‚
 âœ˜ Get inventory stats
   â”‚
   â”‚ Failed asserting that 0 is greater than 0.
   â”‚
   â”‚ /workspaces/shulelabsci4/tests/Inventory/InventoryServiceTest.php:142
   â”‚
 âœ˜ Search assets
   â”‚
   â”‚ Failed asserting that 0 is greater than 0.
   â”‚
   â”‚ /workspaces/shulelabsci4/tests/Inventory/InventoryServiceTest.php:153
   â”‚
 âœ˜ Transfer asset
   â”‚
   â”‚ Failed asserting that false is true.
   â”‚
   â”‚ /workspaces/shulelabsci4/tests/Inventory/InventoryServiceTest.php:163
   â”‚

Invoice Service (Tests\Ci4\Finance\InvoiceService)
 âœ” Issue invoice commits ledger and records audit
 âœ” Settle invoice creates ledger entries and updates status

Learning Service (Tests\Learning\LearningService)
 âœ˜ Get school courses
   â”‚
   â”‚ Failed asserting that 0 is greater than 0.
   â”‚
   â”‚ /workspaces/shulelabsci4/tests/Learning/LearningServiceTest.php:34
   â”‚
 âœ˜ Create course
   â”‚
   â”‚ ErrorException: Trying to access array offset on null
   â”‚
   â”‚ /workspaces/shulelabsci4/tests/Learning/LearningServiceTest.php:46
   â”‚
 âœ˜ Get course assignments
   â”‚
   â”‚ Failed asserting that 0 is greater than 0.
   â”‚
   â”‚ /workspaces/shulelabsci4/tests/Learning/LearningServiceTest.php:63
   â”‚
 âœ˜ Create assignment
   â”‚
   â”‚ ErrorException: Trying to access array offset on null
   â”‚
   â”‚ /workspaces/shulelabsci4/tests/Learning/LearningServiceTest.php:86
   â”‚
 âœ˜ Submit grade
   â”‚
   â”‚ Failed asserting that false is true.
   â”‚
   â”‚ /workspaces/shulelabsci4/tests/Learning/LearningServiceTest.php:102
   â”‚
 âœ˜ Cannot exceed max points
   â”‚
   â”‚ Failed asserting that 'Assignment not found' [ASCII](length: 20) contains "exceed maximum" [ASCII](length: 14).
   â”‚
   â”‚ /workspaces/shulelabsci4/tests/Learning/LearningServiceTest.php:128
   â”‚
 âœ˜ Update existing grade
   â”‚
   â”‚ Failed asserting that false is true.
   â”‚
   â”‚ /workspaces/shulelabsci4/tests/Learning/LearningServiceTest.php:146
   â”‚
 âœ˜ Get student grades
   â”‚
   â”‚ Failed asserting that actual size 0 matches expected size 2.
   â”‚
   â”‚ /workspaces/shulelabsci4/tests/Learning/LearningServiceTest.php:174
   â”‚
 âœ˜ Get course average
   â”‚
   â”‚ Failed asserting that null is not null.
   â”‚
   â”‚ /workspaces/shulelabsci4/tests/Learning/LearningServiceTest.php:192
   â”‚
 âœ˜ Get assignment stats
   â”‚
   â”‚ Failed asserting that 0 matches expected 3.
   â”‚
   â”‚ /workspaces/shulelabsci4/tests/Learning/LearningServiceTest.php:213
   â”‚

Ledger Service (Tests\Ci4\Foundation\LedgerService)
 âœ” Commit transaction persists ledger and audit
 âœ” Commit transaction throws when unbalanced
 âœ” Commit transaction throws when period locked
 âœ” Schedule reversal creates opposite entries

Library Service (Tests\Library\LibraryService)
 âœ˜ Add book
   â”‚
   â”‚ ErrorException: Trying to access array offset on null
   â”‚
   â”‚ /workspaces/shulelabsci4/tests/Library/LibraryServiceTest.php:35
   â”‚
 âœ˜ Get school books
   â”‚
   â”‚ Failed asserting that 0 is greater than 0.
   â”‚
   â”‚ /workspaces/shulelabsci4/tests/Library/LibraryServiceTest.php:49
   â”‚
 âœ” Get school books by category
 âœ˜ Borrow book
   â”‚
   â”‚ Failed asserting that false is true.
   â”‚
   â”‚ /workspaces/shulelabsci4/tests/Library/LibraryServiceTest.php:74
   â”‚
 âœ˜ Cannot borrow when no copies available
   â”‚
   â”‚ Failed asserting that 'Book not found' [ASCII](length: 14) contains "No copies available" [ASCII](length: 19).
   â”‚
   â”‚ /workspaces/shulelabsci4/tests/Library/LibraryServiceTest.php:95
   â”‚
 âœ˜ Return book
   â”‚
   â”‚ ErrorException: Undefined array key "borrowing_id"
   â”‚
   â”‚ /workspaces/shulelabsci4/tests/Library/LibraryServiceTest.php:104
   â”‚
 âœ˜ Cannot return book twice
   â”‚
   â”‚ ErrorException: Undefined array key "borrowing_id"
   â”‚
   â”‚ /workspaces/shulelabsci4/tests/Library/LibraryServiceTest.php:125
   â”‚
 âœ˜ Get student borrowings
   â”‚
   â”‚ Failed asserting that actual size 0 matches expected size 2.
   â”‚
   â”‚ /workspaces/shulelabsci4/tests/Library/LibraryServiceTest.php:146
   â”‚
 âœ˜ Get overdue books
   â”‚
   â”‚ Failed asserting that 0 is greater than 0.
   â”‚
   â”‚ /workspaces/shulelabsci4/tests/Library/LibraryServiceTest.php:158
   â”‚
 âœ˜ Get library stats
   â”‚
   â”‚ Failed asserting that 0 is greater than 0.
   â”‚
   â”‚ /workspaces/shulelabsci4/tests/Library/LibraryServiceTest.php:174
   â”‚
 âœ˜ Search books
   â”‚
   â”‚ Failed asserting that 0 is greater than 0.
   â”‚
   â”‚ /workspaces/shulelabsci4/tests/Library/LibraryServiceTest.php:186
   â”‚

Local Storage Adapter (Tests\Ci4\Integrations\LocalStorageAdapter)
 âœ” Get name returns correct value
 âœ” Check status returns ok for writable path
 âœ” List returns empty array for empty directory
 âœ” Upload creates file in storage
 âœ” List returns files in directory

Maker Checker Service (Tests\Ci4\Foundation\MakerCheckerService)
 âœ” Submit creates pending request and audit
 âœ” Approve updates status and audit
 âœ” Reject updates status and audit
 âœ” Approve throws when request missing

Mobile Api Service (Tests\Mobile\MobileApiService)
 âœ” Format response
 âœ” Format pagination
 âœ” Get dashboard
 âœ” Get student profile
 âœ” Get class students
 âœ” Get invoices
 âœ” Get invoices with status
 âœ” Get library books
 âœ” Get courses
 âœ” Get student grades
 âœ” Pagination has more
 âœ” Mobile invoice data simplified

Moodle Dispatch Runner (Tests\Ci4\Learning\MoodleDispatchRunner)
 âœ” Run grades processes queued dispatch
 âœ” Run grades marks failed on exception
 âœ” Run enrollments processes queued dispatch

Moodle Sync Service (Tests\Ci4\Learning\MoodleSyncService)
 âœ” Push grades registers dispatch and marks completed
 âœ” Push grades marks failure when client throws
 âœ” Sync enrollments uses integration registry
 âœ” Push grades uses stable idempotency key

Offline Snapshot Service (Tests\Ci4\Mobile\OfflineSnapshotService)
 âœ” Issue and verify snapshot
 âœ” Verification fails when signature is tampered
 âœ” Rotate signing key retains previous keys for verification
 âœ” Active key overrides fallback keys
 âœ” Metadata retains numeric dataset keys
 âœ” Verification fails when tenant id is missing
 âœ” Verification fails when tenant id does not match snapshot

Payroll Approval Service (Tests\Ci4\Hr\PayrollApprovalService)
 âœ” List pending and approve
 âœ” Reject requires reason
 âœ” Summarise aggregates statuses

Payroll Service (Tests\Ci4\Hr\PayrollService)
 âœ” Generates kenyan payslip with statutory breakdown
 âœ” Legacy period applies flat nssf and no shif

Qr Service (Tests\Ci4\Foundation\QrService)
 âœ” Issue token persists record and returns artifacts
 âœ” Verify records scan
 âœ” Verify throws for expired token

School Service (Tests\Foundation\SchoolService)
 âœ” Get dashboard stats
 âœ˜ Get dashboard stats for school 1
   â”‚
   â”‚ Failed asserting that 27 matches expected 25.
   â”‚
   â”‚ /workspaces/shulelabsci4/tests/Foundation/SchoolServiceTest.php:149
   â”‚
 âœ” Get dashboard stats for school 2
 âœ” Get school overview
 âœ” Can enroll students
 âœ” Can enroll students respects cap
 âœ” Get available schools
 âœ” Get dashboard stats throws for invalid school
 âœ” School overview includes enrollment counts
 âœ” Utilization calculation

Snapshot Telemetry Service (Tests\Ci4\Mobile\SnapshotTelemetryService)
 âœ” Telemetry aggregates issued verified and failures

Soft Delete Manager (Tests\Ci4\Foundation\SoftDeleteManager)
 âœ” Soft delete marks record and audits
 âœ” Soft delete throws when record missing

Tenant (Tests\Foundation\Tenant)
 âœ˜ Tenant service exists
   â”‚
   â”‚ CodeIgniter\Database\Exceptions\DatabaseException: UNIQUE constraint failed: roles.id
   â”‚
   â”‚ /workspaces/shulelabsci4/vendor/codeigniter4/framework/system/Database/BaseConnection.php:684
   â”‚ /workspaces/shulelabsci4/vendor/codeigniter4/framework/system/Database/BaseBuilder.php:1841
   â”‚ /workspaces/shulelabsci4/vendor/codeigniter4/framework/system/Database/BaseBuilder.php:2230
   â”‚ /workspaces/shulelabsci4/tests/Foundation/TenantTest.php:100
   â”‚ /workspaces/shulelabsci4/tests/Foundation/TenantTest.php:44
   â”‚
 âœ” Set current school by session
 âœ” Set current school by primary school
 âœ˜ Switch school
   â”‚
   â”‚ Failed asserting that false is true.
   â”‚
   â”‚ /workspaces/shulelabsci4/tests/Foundation/TenantTest.php:227
   â”‚
 âœ” Switch school fails for unauthorized user
 âœ˜ Get user schools
   â”‚
   â”‚ Failed asserting that actual size 0 matches expected size 1.
   â”‚
   â”‚ /workspaces/shulelabsci4/tests/Foundation/TenantTest.php:248
   â”‚
 âœ˜ Has access to school
   â”‚
   â”‚ Failed asserting that false is true.
   â”‚
   â”‚ /workspaces/shulelabsci4/tests/Foundation/TenantTest.php:258
   â”‚
 âš  Tenant model auto scoping
 âœ˜ Tenant model for school
   â”‚
   â”‚ Failed asserting that an array is not empty.
   â”‚
   â”‚ /workspaces/shulelabsci4/tests/Foundation/TenantTest.php:296
   â”‚
 âœ” Tenant model without tenant
 âœ˜ Tenant model for schools
   â”‚
   â”‚ Failed asserting that an array contains 1.
   â”‚
   â”‚ /workspaces/shulelabsci4/tests/Foundation/TenantTest.php:318
   â”‚
 âš  School 1 cannot see school 2 data
 âœ” Data leakage prevention between schools
 âœ˜ User can belong to multiple schools
   â”‚
   â”‚ Failed asserting that an array contains 1.
   â”‚
   â”‚ /workspaces/shulelabsci4/tests/Foundation/TenantTest.php:404
   â”‚
 âœ˜ Primary school identification
   â”‚
   â”‚ Failed asserting that null is not null.
   â”‚
   â”‚ /workspaces/shulelabsci4/tests/Foundation/TenantTest.php:422
   â”‚
 âœ˜ Get active schools
   â”‚
   â”‚ Failed asserting that actual size 10 matches expected size 5.
   â”‚
   â”‚ /workspaces/shulelabsci4/tests/Foundation/TenantTest.php:435
   â”‚
 âœ” Get school by code
 âœ˜ Get school statistics
   â”‚
   â”‚ Failed asserting that 0 matches expected 2.
   â”‚
   â”‚ /workspaces/shulelabsci4/tests/Foundation/TenantTest.php:458
   â”‚
 âœ” Assign user to school
 âœ” Set primary school

Tenant Resolver (Tests\Ci4\Foundation\TenantResolver)
 âœ” From identifiers resolves context
 âœ” From request uses json header
 âœ” From identifiers throws when unknown tenant

Thread Service (Tests\Ci4\Threads\ThreadService)
 âœ” Create thread persists dispatches and audits
 âœ” Post message appends message and dispatches event

Threads Service (Tests\Threads\ThreadsService)
 âœ˜ Send message
   â”‚
   â”‚ ErrorException: Trying to access array offset on null
   â”‚
   â”‚ /workspaces/shulelabsci4/tests/Threads/ThreadsServiceTest.php:35
   â”‚
 âœ˜ Get inbox
   â”‚
   â”‚ Failed asserting that 0 is greater than 0.
   â”‚
   â”‚ /workspaces/shulelabsci4/tests/Threads/ThreadsServiceTest.php:47
   â”‚
 âœ” Get inbox unread only
 âœ˜ Get sent messages
   â”‚
   â”‚ Failed asserting that 0 is greater than 0.
   â”‚
   â”‚ /workspaces/shulelabsci4/tests/Threads/ThreadsServiceTest.php:69
   â”‚
 âœ˜ Mark as read
   â”‚
   â”‚ Failed asserting that false is true.
   â”‚
   â”‚ /workspaces/shulelabsci4/tests/Threads/ThreadsServiceTest.php:79
   â”‚
 âœ˜ Delete message
   â”‚
   â”‚ Failed asserting that false is true.
   â”‚
   â”‚ /workspaces/shulelabsci4/tests/Threads/ThreadsServiceTest.php:94
   â”‚
 âœ˜ Cannot delete others message
   â”‚
   â”‚ Failed asserting that 'Message not found' [ASCII](length: 17) contains "Unauthorized" [ASCII](length: 12).
   â”‚
   â”‚ /workspaces/shulelabsci4/tests/Threads/ThreadsServiceTest.php:109
   â”‚
 âœ˜ Create announcement
   â”‚
   â”‚ ErrorException: Trying to access array offset on null
   â”‚
   â”‚ /workspaces/shulelabsci4/tests/Threads/ThreadsServiceTest.php:121
   â”‚
 âœ˜ Get announcements
   â”‚
   â”‚ Failed asserting that 0 is greater than 0.
   â”‚
   â”‚ /workspaces/shulelabsci4/tests/Threads/ThreadsServiceTest.php:133
   â”‚
 âœ˜ Deactivate announcement
   â”‚
   â”‚ Failed asserting that false is true.
   â”‚
   â”‚ /workspaces/shulelabsci4/tests/Threads/ThreadsServiceTest.php:143
   â”‚
 âœ” Get unread count
 âœ˜ Get message thread
   â”‚
   â”‚ Failed asserting that 0 is equal to 3 or is greater than 3.
   â”‚
   â”‚ /workspaces/shulelabsci4/tests/Threads/ThreadsServiceTest.php:171
   â”‚

Transfer Service (Tests\Ci4\Inventory\TransferService)
 âœ” Initiate transfer queues approval issues qr and records audit
 âœ” Complete transfer approves maker checker on acceptance
 âœ” Complete transfer throws exception on already completed transfer
 âœ” Complete transfer throws exception when transfer is not pending

User Migration Service (Tests\Ci4\Services\UserMigrationService)
 âœ” Find and migrate user returns null when user not found
 âœ” Extract school i d handles null school i d
 âœ” Extract school i d returns string when set
 âœ” Extract created at returns current date when not set
 âœ” Extract created at uses create date when available
 âœ” Extract updated at prefers modify date
 âœ” Extract updated at falls back to create date

There were 2 risky tests:

1) Tests\Foundation\TenantTest::testTenantModelAutoScoping
This test did not perform any assertions

/workspaces/shulelabsci4/tests/Foundation/TenantTest.php:268

2) Tests\Foundation\TenantTest::testSchool1CannotSeeSchool2Data
This test did not perform any assertions

/workspaces/shulelabsci4/tests/Foundation/TenantTest.php:327

ERRORS!
Tests: 206, Assertions: 664, Errors: 9, Failures: 44, PHPUnit Deprecations: 1, Risky: 2.
[1;33mâš ï¸  [2025-11-23 18:08:59][0m Some tests failed (this is expected in TDD)
[0;36mâ„¹ï¸  [2025-11-23 18:08:59][0m Generating code coverage report...
Xdebug: [Step Debug] Could not connect to debugging client. Tried: localhost:9003 (through xdebug.client_host/xdebug.client_port).
PHPUnit 10.5.58 by Sebastian Bergmann and contributors.

Runtime:       PHP 8.3.14
Configuration: /workspaces/shulelabsci4/phpunit.xml

.........Starting CI4 users backfill from CI3 tables...
Table systemadmin does not exist, skipping.
Migrated 0 users from systemadmin
Table user does not exist, skipping.
Migrated 0 users from user
Table teacher does not exist, skipping.
Migrated 0 users from teacher
Table student does not exist, skipping.
Migrated 0 users from student
Table parents does not exist, skipping.
Migrated 0 users from parents
Total users migrated: 0
...................................................F..  63 / 206 ( 30%)
...........E..F.FFRF.FR.FFF.F........FF..................EF.FFF 126 / 206 ( 61%)
FFFFF....FEFEFFFFFF........EF.FFEEFFFF......................... 189 / 206 ( 91%)
.....EF.FFFFEFF.F                                               206 / 206 (100%)

Time: 00:03.824, Memory: 24.00 MB

There was 1 PHPUnit test runner warning:

1) XDEBUG_MODE=coverage (environment variable) or xdebug.mode=coverage (PHP configuration setting) has to be set

--

There were 9 errors:

1) Tests\Foundation\TenantTest::testTenantServiceExists
CodeIgniter\Database\Exceptions\DatabaseException: UNIQUE constraint failed: roles.id

/workspaces/shulelabsci4/vendor/codeigniter4/framework/system/Database/BaseConnection.php:684
/workspaces/shulelabsci4/vendor/codeigniter4/framework/system/Database/BaseBuilder.php:1841
/workspaces/shulelabsci4/vendor/codeigniter4/framework/system/Database/BaseBuilder.php:2230
/workspaces/shulelabsci4/tests/Foundation/TenantTest.php:100
/workspaces/shulelabsci4/tests/Foundation/TenantTest.php:44

Caused by
CodeIgniter\Database\Exceptions\DatabaseException: UNIQUE constraint failed: roles.id

/workspaces/shulelabsci4/vendor/codeigniter4/framework/system/Database/SQLite3/Connection.php:181
/workspaces/shulelabsci4/vendor/codeigniter4/framework/system/Database/BaseConnection.php:729
/workspaces/shulelabsci4/vendor/codeigniter4/framework/system/Database/BaseConnection.php:646
/workspaces/shulelabsci4/vendor/codeigniter4/framework/system/Database/BaseBuilder.php:1841
/workspaces/shulelabsci4/vendor/codeigniter4/framework/system/Database/BaseBuilder.php:2230
/workspaces/shulelabsci4/tests/Foundation/TenantTest.php:100
/workspaces/shulelabsci4/tests/Foundation/TenantTest.php:44

Caused by
SQLite3Exception: UNIQUE constraint failed: roles.id

/workspaces/shulelabsci4/vendor/codeigniter4/framework/system/Database/SQLite3/Connection.php:175
/workspaces/shulelabsci4/vendor/codeigniter4/framework/system/Database/BaseConnection.php:729
/workspaces/shulelabsci4/vendor/codeigniter4/framework/system/Database/BaseConnection.php:646
/workspaces/shulelabsci4/vendor/codeigniter4/framework/system/Database/BaseBuilder.php:1841
/workspaces/shulelabsci4/vendor/codeigniter4/framework/system/Database/BaseBuilder.php:2230
/workspaces/shulelabsci4/tests/Foundation/TenantTest.php:100
/workspaces/shulelabsci4/tests/Foundation/TenantTest.php:44

2) Tests\Inventory\InventoryServiceTest::testAddAsset
ErrorException: Trying to access array offset on null

/workspaces/shulelabsci4/tests/Inventory/InventoryServiceTest.php:35

3) Tests\Learning\LearningServiceTest::testCreateCourse
ErrorException: Trying to access array offset on null

/workspaces/shulelabsci4/tests/Learning/LearningServiceTest.php:46

4) Tests\Learning\LearningServiceTest::testCreateAssignment
ErrorException: Trying to access array offset on null

/workspaces/shulelabsci4/tests/Learning/LearningServiceTest.php:86

5) Tests\Library\LibraryServiceTest::testAddBook
ErrorException: Trying to access array offset on null

/workspaces/shulelabsci4/tests/Library/LibraryServiceTest.php:35

6) Tests\Library\LibraryServiceTest::testReturnBook
ErrorException: Undefined array key "borrowing_id"

/workspaces/shulelabsci4/tests/Library/LibraryServiceTest.php:104

7) Tests\Library\LibraryServiceTest::testCannotReturnBookTwice
ErrorException: Undefined array key "borrowing_id"

/workspaces/shulelabsci4/tests/Library/LibraryServiceTest.php:125

8) Tests\Threads\ThreadsServiceTest::testSendMessage
ErrorException: Trying to access array offset on null

/workspaces/shulelabsci4/tests/Threads/ThreadsServiceTest.php:35

9) Tests\Threads\ThreadsServiceTest::testCreateAnnouncement
ErrorException: Trying to access array offset on null

/workspaces/shulelabsci4/tests/Threads/ThreadsServiceTest.php:121

--

There were 44 failures:

1) Tests\Foundation\SchoolServiceTest::testGetDashboardStatsForSchool1
Failed asserting that 27 matches expected 25.

/workspaces/shulelabsci4/tests/Foundation/SchoolServiceTest.php:149

2) Tests\Foundation\TenantTest::testSwitchSchool
Failed asserting that false is true.

/workspaces/shulelabsci4/tests/Foundation/TenantTest.php:227

3) Tests\Foundation\TenantTest::testGetUserSchools
Failed asserting that actual size 0 matches expected size 1.

/workspaces/shulelabsci4/tests/Foundation/TenantTest.php:248

4) Tests\Foundation\TenantTest::testHasAccessToSchool
Failed asserting that false is true.

/workspaces/shulelabsci4/tests/Foundation/TenantTest.php:258

5) Tests\Foundation\TenantTest::testTenantModelForSchool
Failed asserting that an array is not empty.

/workspaces/shulelabsci4/tests/Foundation/TenantTest.php:296

6) Tests\Foundation\TenantTest::testTenantModelForSchools
Failed asserting that an array contains 1.

/workspaces/shulelabsci4/tests/Foundation/TenantTest.php:318

7) Tests\Foundation\TenantTest::testUserCanBelongToMultipleSchools
Failed asserting that an array contains 1.

/workspaces/shulelabsci4/tests/Foundation/TenantTest.php:404

8) Tests\Foundation\TenantTest::testPrimarySchoolIdentification
Failed asserting that null is not null.

/workspaces/shulelabsci4/tests/Foundation/TenantTest.php:422

9) Tests\Foundation\TenantTest::testGetActiveSchools
Failed asserting that actual size 10 matches expected size 5.

/workspaces/shulelabsci4/tests/Foundation/TenantTest.php:435

10) Tests\Foundation\TenantTest::testGetSchoolStatistics
Failed asserting that 0 matches expected 2.

/workspaces/shulelabsci4/tests/Foundation/TenantTest.php:458

11) Tests\Hr\HrServiceTest::testGetTeacherClasses
Failed asserting that 0 is greater than 0.

/workspaces/shulelabsci4/tests/Hr/HrServiceTest.php:179

12) Tests\Hr\HrServiceTest::testAssignTeacherToClass
Failed asserting that false is true.

/workspaces/shulelabsci4/tests/Hr/HrServiceTest.php:187

13) Tests\Inventory\InventoryServiceTest::testGetSchoolAssets
Failed asserting that 0 is greater than 0.

/workspaces/shulelabsci4/tests/Inventory/InventoryServiceTest.php:48

14) Tests\Inventory\InventoryServiceTest::testUpdateQuantityIn
Failed asserting that false is true.

/workspaces/shulelabsci4/tests/Inventory/InventoryServiceTest.php:71

15) Tests\Inventory\InventoryServiceTest::testUpdateQuantityOut
Failed asserting that false is true.

/workspaces/shulelabsci4/tests/Inventory/InventoryServiceTest.php:86

16) Tests\Inventory\InventoryServiceTest::testCannotReduceBelowZero
Failed asserting that 'Asset not found' [ASCII](length: 15) contains "Insufficient quantity" [ASCII](length: 21).

/workspaces/shulelabsci4/tests/Inventory/InventoryServiceTest.php:98

17) Tests\Inventory\InventoryServiceTest::testGetAssetTransactions
Failed asserting that 0 is equal to 3 or is greater than 3.

/workspaces/shulelabsci4/tests/Inventory/InventoryServiceTest.php:113

18) Tests\Inventory\InventoryServiceTest::testGetLowStockItems
Failed asserting that 0 is greater than 0.

/workspaces/shulelabsci4/tests/Inventory/InventoryServiceTest.php:124

19) Tests\Inventory\InventoryServiceTest::testGetInventoryStats
Failed asserting that 0 is greater than 0.

/workspaces/shulelabsci4/tests/Inventory/InventoryServiceTest.php:142

20) Tests\Inventory\InventoryServiceTest::testSearchAssets
Failed asserting that 0 is greater than 0.

/workspaces/shulelabsci4/tests/Inventory/InventoryServiceTest.php:153

21) Tests\Inventory\InventoryServiceTest::testTransferAsset
Failed asserting that false is true.

/workspaces/shulelabsci4/tests/Inventory/InventoryServiceTest.php:163

22) Tests\Learning\LearningServiceTest::testGetSchoolCourses
Failed asserting that 0 is greater than 0.

/workspaces/shulelabsci4/tests/Learning/LearningServiceTest.php:34

23) Tests\Learning\LearningServiceTest::testGetCourseAssignments
Failed asserting that 0 is greater than 0.

/workspaces/shulelabsci4/tests/Learning/LearningServiceTest.php:63

24) Tests\Learning\LearningServiceTest::testSubmitGrade
Failed asserting that false is true.

/workspaces/shulelabsci4/tests/Learning/LearningServiceTest.php:102

25) Tests\Learning\LearningServiceTest::testCannotExceedMaxPoints
Failed asserting that 'Assignment not found' [ASCII](length: 20) contains "exceed maximum" [ASCII](length: 14).

/workspaces/shulelabsci4/tests/Learning/LearningServiceTest.php:128

26) Tests\Learning\LearningServiceTest::testUpdateExistingGrade
Failed asserting that false is true.

/workspaces/shulelabsci4/tests/Learning/LearningServiceTest.php:146

27) Tests\Learning\LearningServiceTest::testGetStudentGrades
Failed asserting that actual size 0 matches expected size 2.

/workspaces/shulelabsci4/tests/Learning/LearningServiceTest.php:174

28) Tests\Learning\LearningServiceTest::testGetCourseAverage
Failed asserting that null is not null.

/workspaces/shulelabsci4/tests/Learning/LearningServiceTest.php:192

29) Tests\Learning\LearningServiceTest::testGetAssignmentStats
Failed asserting that 0 matches expected 3.

/workspaces/shulelabsci4/tests/Learning/LearningServiceTest.php:213

30) Tests\Library\LibraryServiceTest::testGetSchoolBooks
Failed asserting that 0 is greater than 0.

/workspaces/shulelabsci4/tests/Library/LibraryServiceTest.php:49

31) Tests\Library\LibraryServiceTest::testBorrowBook
Failed asserting that false is true.

/workspaces/shulelabsci4/tests/Library/LibraryServiceTest.php:74

32) Tests\Library\LibraryServiceTest::testCannotBorrowWhenNoCopiesAvailable
Failed asserting that 'Book not found' [ASCII](length: 14) contains "No copies available" [ASCII](length: 19).

/workspaces/shulelabsci4/tests/Library/LibraryServiceTest.php:95

33) Tests\Library\LibraryServiceTest::testGetStudentBorrowings
Failed asserting that actual size 0 matches expected size 2.

/workspaces/shulelabsci4/tests/Library/LibraryServiceTest.php:146

34) Tests\Library\LibraryServiceTest::testGetOverdueBooks
Failed asserting that 0 is greater than 0.

/workspaces/shulelabsci4/tests/Library/LibraryServiceTest.php:158

35) Tests\Library\LibraryServiceTest::testGetLibraryStats
Failed asserting that 0 is greater than 0.

/workspaces/shulelabsci4/tests/Library/LibraryServiceTest.php:174

36) Tests\Library\LibraryServiceTest::testSearchBooks
Failed asserting that 0 is greater than 0.

/workspaces/shulelabsci4/tests/Library/LibraryServiceTest.php:186

37) Tests\Threads\ThreadsServiceTest::testGetInbox
Failed asserting that 0 is greater than 0.

/workspaces/shulelabsci4/tests/Threads/ThreadsServiceTest.php:47

38) Tests\Threads\ThreadsServiceTest::testGetSentMessages
Failed asserting that 0 is greater than 0.

/workspaces/shulelabsci4/tests/Threads/ThreadsServiceTest.php:69

39) Tests\Threads\ThreadsServiceTest::testMarkAsRead
Failed asserting that false is true.

/workspaces/shulelabsci4/tests/Threads/ThreadsServiceTest.php:79

40) Tests\Threads\ThreadsServiceTest::testDeleteMessage
Failed asserting that false is true.

/workspaces/shulelabsci4/tests/Threads/ThreadsServiceTest.php:94

41) Tests\Threads\ThreadsServiceTest::testCannotDeleteOthersMessage
Failed asserting that 'Message not found' [ASCII](length: 17) contains "Unauthorized" [ASCII](length: 12).

/workspaces/shulelabsci4/tests/Threads/ThreadsServiceTest.php:109

42) Tests\Threads\ThreadsServiceTest::testGetAnnouncements
Failed asserting that 0 is greater than 0.

/workspaces/shulelabsci4/tests/Threads/ThreadsServiceTest.php:133

43) Tests\Threads\ThreadsServiceTest::testDeactivateAnnouncement
Failed asserting that false is true.

/workspaces/shulelabsci4/tests/Threads/ThreadsServiceTest.php:143

44) Tests\Threads\ThreadsServiceTest::testGetMessageThread
Failed asserting that 0 is equal to 3 or is greater than 3.

/workspaces/shulelabsci4/tests/Threads/ThreadsServiceTest.php:171

--

There were 2 risky tests:

1) Tests\Foundation\TenantTest::testTenantModelAutoScoping
This test did not perform any assertions

/workspaces/shulelabsci4/tests/Foundation/TenantTest.php:268

2) Tests\Foundation\TenantTest::testSchool1CannotSeeSchool2Data
This test did not perform any assertions

/workspaces/shulelabsci4/tests/Foundation/TenantTest.php:327

ERRORS!
Tests: 206, Assertions: 664, Errors: 9, Failures: 44, PHPUnit Warnings: 1, PHPUnit Deprecations: 1, Risky: 2.
[0;32mâœ… [2025-11-23 18:09:03][0m Phase 2 complete in 8 seconds
[0;34m[2025-11-23 18:09:03][0m â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—
[0;34m[2025-11-23 18:09:03][0m â•‘ PHASE 3: PROGRESSIVE FEATURE BUILDING                          â•‘
[0;34m[2025-11-23 18:09:03][0m â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
[0;36mâ„¹ï¸  [2025-11-23 18:09:03][0m This phase requires AI code generation
[0;36mâ„¹ï¸  [2025-11-23 18:09:03][0m Invoke with: @Copilot orchestrate feature [name]
[0;36mâ„¹ï¸  [2025-11-23 18:09:03][0m Running continuous validation...
[0;32mâœ… [2025-11-23 18:09:04][0m Syntax check passed
[0;32mâœ… [2025-11-23 18:09:04][0m Phase 3 complete in 1 seconds
[0;34m[2025-11-23 18:09:04][0m â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—
[0;34m[2025-11-23 18:09:04][0m â•‘ PHASE 4: CONTINUOUS INTEGRATION                                â•‘
[0;34m[2025-11-23 18:09:04][0m â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
[0;36mâ„¹ï¸  [2025-11-23 18:09:04][0m Running full test suite...
Xdebug: [Step Debug] Could not connect to debugging client. Tried: localhost:9003 (through xdebug.client_host/xdebug.client_port).
PHPUnit 10.5.58 by Sebastian Bergmann and contributors.

Runtime:       PHP 8.3.14
Configuration: /workspaces/shulelabsci4/phpunit.xml

.........Starting CI4 users backfill from CI3 tables...
Table systemadmin does not exist, skipping.
Migrated 0 users from systemadmin
Table user does not exist, skipping.
Migrated 0 users from user
Table teacher does not exist, skipping.
Migrated 0 users from teacher
Table student does not exist, skipping.
Migrated 0 users from student
Table parents does not exist, skipping.
Migrated 0 users from parents
Total users migrated: 0
...................................................F..  63 / 206 ( 30%)
...........E..F.FFRF.FR.FFF.F........FF..................EF.FFF 126 / 206 ( 61%)
FFFFF....FEFEFFFFFF........EF.FFEEFFFF......................... 189 / 206 ( 91%)
.....EF.FFFFEFF.F                                               206 / 206 (100%)

Time: 00:03.919, Memory: 26.00 MB

Audit Service (Tests\Ci4\Foundation\AuditService)
 âœ” Record event persists hash chain
 âœ” Verify integrity detects tampering
 âœ” Seal day persists seal record

Database Compatibility Service (Tests\Ci4\Compat\DatabaseCompatibilityService)
 âœ” Audit detects missing tables
 âœ” Audit detects missing columns
 âœ” Audit passes when schema is complete
 âœ” Generate sql patches for missing columns
 âœ” Add experimental tables adds okr tables
 âœ” Generate migration content

Database Config (Tests\Ci4\Config\DatabaseConfig)
 âœ” Database config reads from env
 âœ” Default database config has correct structure
 âœ” Tests config uses in memory s q lite

Document Catalog (Tests\Ci4\Library\DocumentCatalog)
 âœ” Register document uploads to drive issues qr and audits

Enrollment Service (Tests\Foundation\EnrollmentService)
 âœ” Enroll student
 âœ” Enroll student with parent
 âœ” Enroll student in non existent class
 âœ” Cannot enroll duplicate student
 âœ” Transfer class
 âœ” Transfer to non existent class
 âœ” Get class enrollments
 âœ” Withdraw student
 âœ” Withdraw non existent enrollment
 âœ” Get class enrollments excludes withdrawn

Event Bus (Tests\Ci4\Threads\EventBus)
 âœ” Dispatch invokes all subscribers and captures failures

Finance Service (Tests\Finance\FinanceService)
 âœ” Get school invoices
 âœ” Create invoice
 âœ” Record payment
 âœ” Record full payment
 âœ” Get invoice details
 âœ” Get payment stats
 âœ” Get outstanding invoices
 âœ” Get fee structure
 âœ” Set fee structure
 âœ” Update fee structure

Gamification Service (Tests\Ci4\Gamification\GamificationService)
 âœ” Handle recognition awarded increments points and awards badges

Hr Service (Tests\Hr\HrService)
 âœ” Get school staff
 âœ” Get school staff with role filter
 âœ” Assign teacher
 âœ” Cannot assign teacher twice
 âœ” Remove teacher
 âœ˜ Get teacher classes
   â”‚
   â”‚ Failed asserting that 0 is greater than 0.
   â”‚
   â”‚ /workspaces/shulelabsci4/tests/Hr/HrServiceTest.php:179
   â”‚
 âœ˜ Assign teacher to class
   â”‚
   â”‚ Failed asserting that false is true.
   â”‚
   â”‚ /workspaces/shulelabsci4/tests/Hr/HrServiceTest.php:187
   â”‚
 âœ” Cannot assign teacher to class in different school
 âœ” Get staff stats
 âœ” Staff stats excludes students and parents

Install Service (Tests\Ci4\Foundation\InstallService)
 âœ” Is installed returns false when no tenants
 âœ” Is installed returns true when tenants exist
 âœ” Check database connection returns true
 âœ” Check migrations returns success
 âœ” Create tenants succeeds
 âœ” Create tenants generates ids when not provided
 âœ” Create admin user succeeds
 âœ” Create admin user throws when username exists
 âœ” Create admin user throws when email exists

Integration Registry (Tests\Ci4\Foundation\IntegrationRegistry)
 âœ” Register dispatch persists and enforces idempotency
 âœ” Mark completed updates status and audit
 âœ” Mark failed updates status and audit
 âœ” Mark completed throws when dispatch missing
 âœ” Claim pending dispatches returns processing rows

Integration Service (Tests\Ci4\Integrations\IntegrationService)
 âœ” Can register adapter
 âœ” Can get registered adapter
 âœ” Get registered adapters returns array
 âœ” Check health returns status
 âœ” Throws exception for unknown adapter

Inventory Service (Tests\Inventory\InventoryService)
 âœ˜ Add asset
   â”‚
   â”‚ ErrorException: Trying to access array offset on null
   â”‚
   â”‚ /workspaces/shulelabsci4/tests/Inventory/InventoryServiceTest.php:35
   â”‚
 âœ˜ Get school assets
   â”‚
   â”‚ Failed asserting that 0 is greater than 0.
   â”‚
   â”‚ /workspaces/shulelabsci4/tests/Inventory/InventoryServiceTest.php:48
   â”‚
 âœ” Get school assets by category
 âœ˜ Update quantity in
   â”‚
   â”‚ Failed asserting that false is true.
   â”‚
   â”‚ /workspaces/shulelabsci4/tests/Inventory/InventoryServiceTest.php:71
   â”‚
 âœ˜ Update quantity out
   â”‚
   â”‚ Failed asserting that false is true.
   â”‚
   â”‚ /workspaces/shulelabsci4/tests/Inventory/InventoryServiceTest.php:86
   â”‚
 âœ˜ Cannot reduce below zero
   â”‚
   â”‚ Failed asserting that 'Asset not found' [ASCII](length: 15) contains "Insufficient quantity" [ASCII](length: 21).
   â”‚
   â”‚ /workspaces/shulelabsci4/tests/Inventory/InventoryServiceTest.php:98
   â”‚
 âœ˜ Get asset transactions
   â”‚
   â”‚ Failed asserting that 0 is equal to 3 or is greater than 3.
   â”‚
   â”‚ /workspaces/shulelabsci4/tests/Inventory/InventoryServiceTest.php:113
   â”‚
 âœ˜ Get low stock items
   â”‚
   â”‚ Failed asserting that 0 is greater than 0.
   â”‚
   â”‚ /workspaces/shulelabsci4/tests/Inventory/InventoryServiceTest.php:124
   â”‚
 âœ˜ Get inventory stats
   â”‚
   â”‚ Failed asserting that 0 is greater than 0.
   â”‚
   â”‚ /workspaces/shulelabsci4/tests/Inventory/InventoryServiceTest.php:142
   â”‚
 âœ˜ Search assets
   â”‚
   â”‚ Failed asserting that 0 is greater than 0.
   â”‚
   â”‚ /workspaces/shulelabsci4/tests/Inventory/InventoryServiceTest.php:153
   â”‚
 âœ˜ Transfer asset
   â”‚
   â”‚ Failed asserting that false is true.
   â”‚
   â”‚ /workspaces/shulelabsci4/tests/Inventory/InventoryServiceTest.php:163
   â”‚

Invoice Service (Tests\Ci4\Finance\InvoiceService)
 âœ” Issue invoice commits ledger and records audit
 âœ” Settle invoice creates ledger entries and updates status

Learning Service (Tests\Learning\LearningService)
 âœ˜ Get school courses
   â”‚
   â”‚ Failed asserting that 0 is greater than 0.
   â”‚
   â”‚ /workspaces/shulelabsci4/tests/Learning/LearningServiceTest.php:34
   â”‚
 âœ˜ Create course
   â”‚
   â”‚ ErrorException: Trying to access array offset on null
   â”‚
   â”‚ /workspaces/shulelabsci4/tests/Learning/LearningServiceTest.php:46
   â”‚
 âœ˜ Get course assignments
   â”‚
   â”‚ Failed asserting that 0 is greater than 0.
   â”‚
   â”‚ /workspaces/shulelabsci4/tests/Learning/LearningServiceTest.php:63
   â”‚
 âœ˜ Create assignment
   â”‚
   â”‚ ErrorException: Trying to access array offset on null
   â”‚
   â”‚ /workspaces/shulelabsci4/tests/Learning/LearningServiceTest.php:86
   â”‚
 âœ˜ Submit grade
   â”‚
   â”‚ Failed asserting that false is true.
   â”‚
   â”‚ /workspaces/shulelabsci4/tests/Learning/LearningServiceTest.php:102
   â”‚
 âœ˜ Cannot exceed max points
   â”‚
   â”‚ Failed asserting that 'Assignment not found' [ASCII](length: 20) contains "exceed maximum" [ASCII](length: 14).
   â”‚
   â”‚ /workspaces/shulelabsci4/tests/Learning/LearningServiceTest.php:128
   â”‚
 âœ˜ Update existing grade
   â”‚
   â”‚ Failed asserting that false is true.
   â”‚
   â”‚ /workspaces/shulelabsci4/tests/Learning/LearningServiceTest.php:146
   â”‚
 âœ˜ Get student grades
   â”‚
   â”‚ Failed asserting that actual size 0 matches expected size 2.
   â”‚
   â”‚ /workspaces/shulelabsci4/tests/Learning/LearningServiceTest.php:174
   â”‚
 âœ˜ Get course average
   â”‚
   â”‚ Failed asserting that null is not null.
   â”‚
   â”‚ /workspaces/shulelabsci4/tests/Learning/LearningServiceTest.php:192
   â”‚
 âœ˜ Get assignment stats
   â”‚
   â”‚ Failed asserting that 0 matches expected 3.
   â”‚
   â”‚ /workspaces/shulelabsci4/tests/Learning/LearningServiceTest.php:213
   â”‚

Ledger Service (Tests\Ci4\Foundation\LedgerService)
 âœ” Commit transaction persists ledger and audit
 âœ” Commit transaction throws when unbalanced
 âœ” Commit transaction throws when period locked
 âœ” Schedule reversal creates opposite entries

Library Service (Tests\Library\LibraryService)
 âœ˜ Add book
   â”‚
   â”‚ ErrorException: Trying to access array offset on null
   â”‚
   â”‚ /workspaces/shulelabsci4/tests/Library/LibraryServiceTest.php:35
   â”‚
 âœ˜ Get school books
   â”‚
   â”‚ Failed asserting that 0 is greater than 0.
   â”‚
   â”‚ /workspaces/shulelabsci4/tests/Library/LibraryServiceTest.php:49
   â”‚
 âœ” Get school books by category
 âœ˜ Borrow book
   â”‚
   â”‚ Failed asserting that false is true.
   â”‚
   â”‚ /workspaces/shulelabsci4/tests/Library/LibraryServiceTest.php:74
   â”‚
 âœ˜ Cannot borrow when no copies available
   â”‚
   â”‚ Failed asserting that 'Book not found' [ASCII](length: 14) contains "No copies available" [ASCII](length: 19).
   â”‚
   â”‚ /workspaces/shulelabsci4/tests/Library/LibraryServiceTest.php:95
   â”‚
 âœ˜ Return book
   â”‚
   â”‚ ErrorException: Undefined array key "borrowing_id"
   â”‚
   â”‚ /workspaces/shulelabsci4/tests/Library/LibraryServiceTest.php:104
   â”‚
 âœ˜ Cannot return book twice
   â”‚
   â”‚ ErrorException: Undefined array key "borrowing_id"
   â”‚
   â”‚ /workspaces/shulelabsci4/tests/Library/LibraryServiceTest.php:125
   â”‚
 âœ˜ Get student borrowings
   â”‚
   â”‚ Failed asserting that actual size 0 matches expected size 2.
   â”‚
   â”‚ /workspaces/shulelabsci4/tests/Library/LibraryServiceTest.php:146
   â”‚
 âœ˜ Get overdue books
   â”‚
   â”‚ Failed asserting that 0 is greater than 0.
   â”‚
   â”‚ /workspaces/shulelabsci4/tests/Library/LibraryServiceTest.php:158
   â”‚
 âœ˜ Get library stats
   â”‚
   â”‚ Failed asserting that 0 is greater than 0.
   â”‚
   â”‚ /workspaces/shulelabsci4/tests/Library/LibraryServiceTest.php:174
   â”‚
 âœ˜ Search books
   â”‚
   â”‚ Failed asserting that 0 is greater than 0.
   â”‚
   â”‚ /workspaces/shulelabsci4/tests/Library/LibraryServiceTest.php:186
   â”‚

Local Storage Adapter (Tests\Ci4\Integrations\LocalStorageAdapter)
 âœ” Get name returns correct value
 âœ” Check status returns ok for writable path
 âœ” List returns empty array for empty directory
 âœ” Upload creates file in storage
 âœ” List returns files in directory

Maker Checker Service (Tests\Ci4\Foundation\MakerCheckerService)
 âœ” Submit creates pending request and audit
 âœ” Approve updates status and audit
 âœ” Reject updates status and audit
 âœ” Approve throws when request missing

Mobile Api Service (Tests\Mobile\MobileApiService)
 âœ” Format response
 âœ” Format pagination
 âœ” Get dashboard
 âœ” Get student profile
 âœ” Get class students
 âœ” Get invoices
 âœ” Get invoices with status
 âœ” Get library books
 âœ” Get courses
 âœ” Get student grades
 âœ” Pagination has more
 âœ” Mobile invoice data simplified

Moodle Dispatch Runner (Tests\Ci4\Learning\MoodleDispatchRunner)
 âœ” Run grades processes queued dispatch
 âœ” Run grades marks failed on exception
 âœ” Run enrollments processes queued dispatch

Moodle Sync Service (Tests\Ci4\Learning\MoodleSyncService)
 âœ” Push grades registers dispatch and marks completed
 âœ” Push grades marks failure when client throws
 âœ” Sync enrollments uses integration registry
 âœ” Push grades uses stable idempotency key

Offline Snapshot Service (Tests\Ci4\Mobile\OfflineSnapshotService)
 âœ” Issue and verify snapshot
 âœ” Verification fails when signature is tampered
 âœ” Rotate signing key retains previous keys for verification
 âœ” Active key overrides fallback keys
 âœ” Metadata retains numeric dataset keys
 âœ” Verification fails when tenant id is missing
 âœ” Verification fails when tenant id does not match snapshot

Payroll Approval Service (Tests\Ci4\Hr\PayrollApprovalService)
 âœ” List pending and approve
 âœ” Reject requires reason
 âœ” Summarise aggregates statuses

Payroll Service (Tests\Ci4\Hr\PayrollService)
 âœ” Generates kenyan payslip with statutory breakdown
 âœ” Legacy period applies flat nssf and no shif

Qr Service (Tests\Ci4\Foundation\QrService)
 âœ” Issue token persists record and returns artifacts
 âœ” Verify records scan
 âœ” Verify throws for expired token

School Service (Tests\Foundation\SchoolService)
 âœ” Get dashboard stats
 âœ˜ Get dashboard stats for school 1
   â”‚
   â”‚ Failed asserting that 27 matches expected 25.
   â”‚
   â”‚ /workspaces/shulelabsci4/tests/Foundation/SchoolServiceTest.php:149
   â”‚
 âœ” Get dashboard stats for school 2
 âœ” Get school overview
 âœ” Can enroll students
 âœ” Can enroll students respects cap
 âœ” Get available schools
 âœ” Get dashboard stats throws for invalid school
 âœ” School overview includes enrollment counts
 âœ” Utilization calculation

Snapshot Telemetry Service (Tests\Ci4\Mobile\SnapshotTelemetryService)
 âœ” Telemetry aggregates issued verified and failures

Soft Delete Manager (Tests\Ci4\Foundation\SoftDeleteManager)
 âœ” Soft delete marks record and audits
 âœ” Soft delete throws when record missing

Tenant (Tests\Foundation\Tenant)
 âœ˜ Tenant service exists
   â”‚
   â”‚ CodeIgniter\Database\Exceptions\DatabaseException: UNIQUE constraint failed: roles.id
   â”‚
   â”‚ /workspaces/shulelabsci4/vendor/codeigniter4/framework/system/Database/BaseConnection.php:684
   â”‚ /workspaces/shulelabsci4/vendor/codeigniter4/framework/system/Database/BaseBuilder.php:1841
   â”‚ /workspaces/shulelabsci4/vendor/codeigniter4/framework/system/Database/BaseBuilder.php:2230
   â”‚ /workspaces/shulelabsci4/tests/Foundation/TenantTest.php:100
   â”‚ /workspaces/shulelabsci4/tests/Foundation/TenantTest.php:44
   â”‚
 âœ” Set current school by session
 âœ” Set current school by primary school
 âœ˜ Switch school
   â”‚
   â”‚ Failed asserting that false is true.
   â”‚
   â”‚ /workspaces/shulelabsci4/tests/Foundation/TenantTest.php:227
   â”‚
 âœ” Switch school fails for unauthorized user
 âœ˜ Get user schools
   â”‚
   â”‚ Failed asserting that actual size 0 matches expected size 1.
   â”‚
   â”‚ /workspaces/shulelabsci4/tests/Foundation/TenantTest.php:248
   â”‚
 âœ˜ Has access to school
   â”‚
   â”‚ Failed asserting that false is true.
   â”‚
   â”‚ /workspaces/shulelabsci4/tests/Foundation/TenantTest.php:258
   â”‚
 âš  Tenant model auto scoping
 âœ˜ Tenant model for school
   â”‚
   â”‚ Failed asserting that an array is not empty.
   â”‚
   â”‚ /workspaces/shulelabsci4/tests/Foundation/TenantTest.php:296
   â”‚
 âœ” Tenant model without tenant
 âœ˜ Tenant model for schools
   â”‚
   â”‚ Failed asserting that an array contains 1.
   â”‚
   â”‚ /workspaces/shulelabsci4/tests/Foundation/TenantTest.php:318
   â”‚
 âš  School 1 cannot see school 2 data
 âœ” Data leakage prevention between schools
 âœ˜ User can belong to multiple schools
   â”‚
   â”‚ Failed asserting that an array contains 1.
   â”‚
   â”‚ /workspaces/shulelabsci4/tests/Foundation/TenantTest.php:404
   â”‚
 âœ˜ Primary school identification
   â”‚
   â”‚ Failed asserting that null is not null.
   â”‚
   â”‚ /workspaces/shulelabsci4/tests/Foundation/TenantTest.php:422
   â”‚
 âœ˜ Get active schools
   â”‚
   â”‚ Failed asserting that actual size 10 matches expected size 5.
   â”‚
   â”‚ /workspaces/shulelabsci4/tests/Foundation/TenantTest.php:435
   â”‚
 âœ” Get school by code
 âœ˜ Get school statistics
   â”‚
   â”‚ Failed asserting that 0 matches expected 2.
   â”‚
   â”‚ /workspaces/shulelabsci4/tests/Foundation/TenantTest.php:458
   â”‚
 âœ” Assign user to school
 âœ” Set primary school

Tenant Resolver (Tests\Ci4\Foundation\TenantResolver)
 âœ” From identifiers resolves context
 âœ” From request uses json header
 âœ” From identifiers throws when unknown tenant

Thread Service (Tests\Ci4\Threads\ThreadService)
 âœ” Create thread persists dispatches and audits
 âœ” Post message appends message and dispatches event

Threads Service (Tests\Threads\ThreadsService)
 âœ˜ Send message
   â”‚
   â”‚ ErrorException: Trying to access array offset on null
   â”‚
   â”‚ /workspaces/shulelabsci4/tests/Threads/ThreadsServiceTest.php:35
   â”‚
 âœ˜ Get inbox
   â”‚
   â”‚ Failed asserting that 0 is greater than 0.
   â”‚
   â”‚ /workspaces/shulelabsci4/tests/Threads/ThreadsServiceTest.php:47
   â”‚
 âœ” Get inbox unread only
 âœ˜ Get sent messages
   â”‚
   â”‚ Failed asserting that 0 is greater than 0.
   â”‚
   â”‚ /workspaces/shulelabsci4/tests/Threads/ThreadsServiceTest.php:69
   â”‚
 âœ˜ Mark as read
   â”‚
   â”‚ Failed asserting that false is true.
   â”‚
   â”‚ /workspaces/shulelabsci4/tests/Threads/ThreadsServiceTest.php:79
   â”‚
 âœ˜ Delete message
   â”‚
   â”‚ Failed asserting that false is true.
   â”‚
   â”‚ /workspaces/shulelabsci4/tests/Threads/ThreadsServiceTest.php:94
   â”‚
 âœ˜ Cannot delete others message
   â”‚
   â”‚ Failed asserting that 'Message not found' [ASCII](length: 17) contains "Unauthorized" [ASCII](length: 12).
   â”‚
   â”‚ /workspaces/shulelabsci4/tests/Threads/ThreadsServiceTest.php:109
   â”‚
 âœ˜ Create announcement
   â”‚
   â”‚ ErrorException: Trying to access array offset on null
   â”‚
   â”‚ /workspaces/shulelabsci4/tests/Threads/ThreadsServiceTest.php:121
   â”‚
 âœ˜ Get announcements
   â”‚
   â”‚ Failed asserting that 0 is greater than 0.
   â”‚
   â”‚ /workspaces/shulelabsci4/tests/Threads/ThreadsServiceTest.php:133
   â”‚
 âœ˜ Deactivate announcement
   â”‚
   â”‚ Failed asserting that false is true.
   â”‚
   â”‚ /workspaces/shulelabsci4/tests/Threads/ThreadsServiceTest.php:143
   â”‚
 âœ” Get unread count
 âœ˜ Get message thread
   â”‚
   â”‚ Failed asserting that 0 is equal to 3 or is greater than 3.
   â”‚
   â”‚ /workspaces/shulelabsci4/tests/Threads/ThreadsServiceTest.php:171
   â”‚

Transfer Service (Tests\Ci4\Inventory\TransferService)
 âœ” Initiate transfer queues approval issues qr and records audit
 âœ” Complete transfer approves maker checker on acceptance
 âœ” Complete transfer throws exception on already completed transfer
 âœ” Complete transfer throws exception when transfer is not pending

User Migration Service (Tests\Ci4\Services\UserMigrationService)
 âœ” Find and migrate user returns null when user not found
 âœ” Extract school i d handles null school i d
 âœ” Extract school i d returns string when set
 âœ” Extract created at returns current date when not set
 âœ” Extract created at uses create date when available
 âœ” Extract updated at prefers modify date
 âœ” Extract updated at falls back to create date

There were 2 risky tests:

1) Tests\Foundation\TenantTest::testTenantModelAutoScoping
This test did not perform any assertions

/workspaces/shulelabsci4/tests/Foundation/TenantTest.php:268

2) Tests\Foundation\TenantTest::testSchool1CannotSeeSchool2Data
This test did not perform any assertions

/workspaces/shulelabsci4/tests/Foundation/TenantTest.php:327

ERRORS!
Tests: 206, Assertions: 664, Errors: 9, Failures: 44, PHPUnit Deprecations: 1, Risky: 2.
