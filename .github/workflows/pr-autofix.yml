name: PR Auto-fix

on:
  pull_request:
    types: [opened, synchronize, reopened]

permissions:
  contents: write
  pull-requests: write

jobs:
  autofix:
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          ref: ${{ github.head_ref }}
          token: ${{ secrets.GITHUB_TOKEN }}
      
      - name: Setup PHP
        uses: shivammathur/setup-php@v2
        with:
          php-version: '8.3'
          extensions: intl, mbstring, mysqli, pdo, zip, gd, bcmath
          coverage: none
      
      # Configure Composer authentication to access private GitHub repositories/packages
      - name: Configure Composer auth
        run: |
          mkdir -p $HOME/.composer
          echo '{"github-oauth":{"github.com":"'"${{ secrets.GITHUB_TOKEN }}"'"}}' > $HOME/.composer/auth.json
      
      - name: Get Composer cache directory
        id: composer-cache
        run: echo "dir=$(composer config cache-files-dir)" >> $GITHUB_OUTPUT
      
      - name: Cache Composer dependencies
        uses: actions/cache@v3
        with:
          path: ${{ steps.composer-cache.outputs.dir }}
          key: ${{ runner.os }}-composer-${{ hashFiles('**/composer.lock') }}
          restore-keys: |
            ${{ runner.os }}-composer-
      
      - name: Install dependencies
        run: |
          # Retry composer install up to 3 times with increasing timeout
          for i in 1 2 3; do
            echo "Attempt $i of 3..."
            if composer install --prefer-dist --no-progress --no-interaction; then
              echo "Composer install succeeded on attempt $i"
              break
            else
              if [ $i -lt 3 ]; then
                echo "Composer install failed, retrying in 5 seconds..."
                sleep 5
              else
                echo "Composer install failed after 3 attempts" >&2
                exit 1
              fi
            fi
          done
      
      - name: Check for syntax errors
        id: syntax-check
        run: |
          echo "Checking PHP syntax..."
          find app -name "*.php" -exec php -l {} \; > /tmp/syntax-check.log 2>&1
          
          if grep -q "Parse error" /tmp/syntax-check.log; then
            echo "status=failed" >> $GITHUB_OUTPUT
            echo "Syntax errors found:"
            cat /tmp/syntax-check.log
            exit 1
          else
            echo "status=passed" >> $GITHUB_OUTPUT
            echo "No syntax errors found"
          fi
      
      - name: Run PHP-CS-Fixer
        id: cs-fixer
        run: |
          echo "Running PHP-CS-Fixer..."
          vendor/bin/php-cs-fixer fix --config=.php-cs-fixer.php --verbose
          
          # Check if any files were modified
          if [[ -n $(git status -s) ]]; then
            echo "changes=true" >> $GITHUB_OUTPUT
            echo "Files were auto-fixed"
          else
            echo "changes=false" >> $GITHUB_OUTPUT
            echo "No formatting changes needed"
          fi
      
      - name: Commit auto-fixes
        if: steps.cs-fixer.outputs.changes == 'true'
        run: |
          git config --local user.email "github-actions[bot]@users.noreply.github.com"
          git config --local user.name "github-actions[bot]"
          git add .
          git commit -m "style: auto-fix code style with PHP-CS-Fixer"
          git push
      
      - name: Add comment on PR
        if: steps.cs-fixer.outputs.changes == 'true'
        uses: actions/github-script@v7
        with:
          script: |
            github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: 'âœ¨ **Auto-fix applied**\n\nCode style has been automatically fixed using PHP-CS-Fixer.'
            })
      
      - name: Summary
        run: |
          echo "## Auto-fix Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "- **Syntax Check**: ${{ steps.syntax-check.outputs.status }}" >> $GITHUB_STEP_SUMMARY
          echo "- **Code Style**: ${{ steps.cs-fixer.outputs.changes == 'true' && 'Fixed' || 'OK' }}" >> $GITHUB_STEP_SUMMARY
